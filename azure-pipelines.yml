variables:
  # When Agent.JobName matches this value (and the git ref is a tag), then
  # built artifacts will be published to Azure Blob Storage.
- name: "AzurePublishWhen"
  value: "BigSur-Xcode-12.5"
- name: "RunTestCloudTestsWhen"
  value: "BigSur-Xcode-13.0"
trigger:
  tags:
    include:
    - '*'
  branches:
    include:
    - master
pr:
  branches:
    include:
    - master
schedules:
- cron: "0 23 * * Mon-Fri"
  displayName: Nightly build
  branches:
    include:
    - master
  always: true

jobs:

- job:
  strategy:
    matrix:
      BigSur-Xcode-12.5:
        IMAGE_POOL: 'macOS-11'
        XCODE_VERSION: '12.5.1'
      BigSur-Xcode-13.0:
        IMAGE_POOL: 'macOS-11'
        XCODE_VERSION: '13.0'
  timeoutInMinutes: 180
  pool:
    vmImage: $(IMAGE_POOL)
  variables:
  - group: XTCRunTimeArtifactsCI

  steps:

  - script: |
      set -e
      sudo xcode-select --switch "/Applications/Xcode_$(XCODE_VERSION).app/Contents/Developer"
      echo "Xcode version: $(xcrun xcodebuild -version)"
      echo "Xcode path: $(xcrun -f xcodebuild)"
      echo "Xcode select path: $(xcode-select --print-path)"
    displayName: "Select Xcode $(XCODE_VERSION)"

  - script: |
      eval "$(/opt/homebrew/bin/rbenv init -)" && ruby -v
      rbenv global 2.7.2
      ruby -v
      gem uninstall bundler
      gem install bundler:2.2.7
      bundle _2.2.7_ install
    displayName: "Bundler 2.2.7 Install"

  - script: |
      set -e
      ruby -v
      echo -e "install: --no-document --env-shebang\nupdate:  --no-document --env-shebang" > ~/.gemrc
      bundle install
    displayName: "Prepare Ruby Environment"

  - script: |
      set -e
      [ -d "calabash-codesign" ] && rm -rf calabash-codesign
      git clone https://$(CalabashKeychainGitHubAccessToken)@github.com/xamarinhq/calabash-codesign.git
      calabash-codesign/apple/create-keychain.sh
    displayName: "Download and install keychain"

      #- script: make app
      #  displayName: "Make app"

  - script: make ipa
    displayName: "Make ipa"

  - script: |
      nuget restore $(Build.SourcesDirectory)/Permissions_UITest/Permissions_UITest/Permissions_UITest.sln
      msbuild $(Build.SourcesDirectory)/Permissions_UITest/Permissions_UITest/Permissions_UITest.csproj
    displayName: Build Permissions_UITest
  - script: |
      export APPCENTER_ACCESS_TOKEN=$(AppCenterAPITokenProd)
      appcenter test run uitest \
      --app "App-Center-Test-Cloud/Palisade-iOS" \
      --devices "App-Center-Test-Cloud/daily-ios" \
      --app-path $(Build.SourcesDirectory)/Products/ipa/Permissions.ipa \
      --locale "en_US" --build-dir $(Build.SourcesDirectory)/Permissions_UITest/Permissions_UITest/bin/Debug/
    displayName: Run Appcenter Test
    condition: eq(variables['Agent.JobName'], variables['RunTestCloudTestsWhen'])


  - task: Bash@3
    inputs:
      targetType: filePath
      filePath: "./bin/ci/az-publish.sh"
    env:
      AZURE_STORAGE_ACCOUNT: $(AzureStorageAccount)
      AZURE_STORAGE_KEY: $(AzureStorageKey)
      AZURE_STORAGE_CONNECTION_STRING: $(AzureStorageConnectionString)
      SOURCE_BRANCH: $(Build.SourceBranch)
    displayName: "Publish to Azure Blob Storage"
    condition: and(succeeded(), eq(variables['Agent.JobName'], variables['AzurePublishWhen']), eq(variables['Build.SourceBranch'], 'refs/heads/master'), eq(variables['Build.Reason'], 'IndividualCI'))

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      failTaskOnFailedTests: true
      testResultsFiles: 'reports/junit/**/*.xml'
    condition: always()
